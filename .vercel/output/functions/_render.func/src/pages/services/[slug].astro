---
import PageLayout from "~/layouts/PageLayout.astro";
import ServicesAll from "~/components/widgets/ServicesAll.astro";
import ConactSection from "~/components/HomePage/ConactSection.astro";
import { BASE_URL } from "~/utils/apliInstance";

export const prerender = false; // âœ… SSR ENABLED

const { slug } = Astro.params;

/* =========================
   FALLBACK DATA (SAFE)
========================= */
const fallbackService = {
  title: "Our Stairlift Services",
  enter_descriptions:
    "Professional stairlift services designed for safety, comfort, and reliability.",
  image: "/images/service-fallback.png", // ðŸ”´ Local image required
  points: [
    "Free in-home assessment",
    "Expert consultation and guidance",
    "Professional installation",
    "Complete safety checks",
    "Ongoing maintenance and support",
  ],
};

/* =========================
   DEFAULT VALUES
========================= */
let service = fallbackService;
let AllserviceData = [];

/* =========================
   SSR DATA FETCHING
========================= */
try {
  if (slug) {
    const serviceURL = `${BASE_URL}/items/Services?filter[slug][_eq]=${slug}`;
    const allServiceURL = `${BASE_URL}/items/Services`;

    const [serviceRes, allServiceRes] = await Promise.allSettled([
      fetch(serviceURL),
      fetch(allServiceURL),
    ]);

    /* SINGLE SERVICE */
    if (
      serviceRes.status === "fulfilled" &&
      serviceRes.value.ok
    ) {
      const serviceJson = await serviceRes.value.json();
      const item = serviceJson?.data?.[0];

      if (item) {
        /* Extract image from HTML */
        const imgMatch = item?.veribage_list?.match(
          /<img[^>]+src="([^">]+)"/
        );

        /* Extract bullet points */
        const points =
          item?.veribage_list
            ?.match(/&bull;([^<]+)/g)
            ?.map(p => p.replace("&bull;", "").trim()) || [];

        service = {
          title: item?.title || fallbackService.title,
          enter_descriptions:
            item?.enter_descriptions || fallbackService.enter_descriptions,
          image: imgMatch?.[1] || fallbackService.image,
          points: points.length ? points : fallbackService.points,
        };
      }
    }

    /* ALL SERVICES */
    if (
      allServiceRes.status === "fulfilled" &&
      allServiceRes.value.ok
    ) {
      const allJson = await allServiceRes.value.json();
      AllserviceData = allJson?.data || [];
    }
  }
} catch (error) {
  console.error("SSR Directus fetch failed â€” fallback used", error);
}
---

<PageLayout>

  <!-- ================= HERO SECTION ================= -->
  <section class="py-20 px-4 sm:px-8 lg:px-16 mt-0 sm:mt-5 lg:mt-14">
    <div class="max-w-7xl mx-auto">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-center">

        <!-- IMAGE -->
        <div class="flex justify-center lg:justify-start">
          <div class="w-full max-w-[672px] aspect-[672/825] overflow-hidden">
            <img
              src={service.image}
              alt={service.title}
              class="w-full h-full object-cover"
              loading="lazy"
            />
          </div>
        </div>

        <!-- CONTENT -->
        <div class="flex flex-col max-w-xl">
          <h1 class="text-3xl sm:text-4xl lg:text-5xl font-semibold mb-4">
            {service.title}
          </h1>

          <p class="text-gray-600 text-base sm:text-lg mb-6">
            {service.enter_descriptions}
          </p>

          {service.points?.length > 0 && (
            <ul class="space-y-4 mb-8">
              {service.points.map(point => (
                <li class="flex items-start gap-3">
                  <span class="mt-2 h-2 w-2 rounded-full bg-secondary"></span>
                  <span class="text-gray-700 leading-relaxed">
                    {point}
                  </span>
                </li>
              ))}
            </ul>
          )}

          <!-- CTA -->
          <div class="flex flex-col gap-4 mt-4 max-w-[580px]">
            <a
              href="/assessment"
              class="bg-secondary text-white text-center py-3 px-6 rounded-md font-medium hover:opacity-90 transition"
            >
              Schedule Your Assessment
            </a>

            <button
              class="border border-secondary text-secondary py-3 px-6 rounded-md font-medium hover:bg-secondary hover:text-white transition"
            >
              Request a Call Back
            </button>
          </div>
        </div>

      </div>
    </div>
  </section>

  <!-- ================= ALL SERVICES ================= -->
  <section class="max-w-7xl mx-auto px-4 sm:px-8 lg:px-16">
    <h2 class="text-3xl sm:text-4xl font-bold text-secondary mb-8">
      Our All Services
    </h2>

    <ServicesAll data={AllserviceData} />
  </section>

  <!-- ================= CONTACT ================= -->
  <ConactSection />

</PageLayout>
