---
import PageLayout from "~/layouts/PageLayout.astro";
import { BASE_URL } from "~/utils/apliInstance";

const metadata = {
  title: "Assessment Services - Safe Stairlift Solutions",
  ignoreTitleTemplate: true,
};

const contactInfo = {
  email: "info@homefreestairs.com",
  phone: "(555) 123-4567",
};

/* Fallback slots */
const fallbackData = [
  "09:00 AM – 10:00 AM",
  "10:00 AM – 11:00 AM",
  "11:00 AM – 12:00 PM",
  "01:00 PM – 02:00 PM",
  "02:00 PM – 03:00 PM",
  "03:00 PM – 04:00 PM",
];

let timeSlots = fallbackData;

/* Fetch slots from Directus */
try {
  const res = await fetch(
    `${BASE_URL}/items/slots?fields=id,start_time,end_time`
  );

  if (res.ok) {
    const apiData = await res.json();

    const formatTime = (time) => {
      const [h, m] = time.split(":");
      const hour = Number(h);
      const suffix = hour >= 12 ? "PM" : "AM";
      const formattedHour = hour % 12 || 12;
      return `${formattedHour}:${m} ${suffix}`;
    };

    timeSlots = apiData.data.map(slot => ({
      id: slot.id,
      label: `${formatTime(slot.start_time)} – ${formatTime(slot.end_time)}`
    }));
  }
} catch (error) {
  console.warn("Directus API failed, using fallback data:", error);
}
let globalData:any = [];
try {
  const res = await fetch(`${BASE_URL}/items/globals`);
  if (res.ok) {
    const apiData = await res.json();
    globalData = apiData?.data
  }
} catch (error) {
  console.warn("Directus About API failed, using fallback data");
}
const today = new Date().toISOString().split('T')[0];

---

<PageLayout metadata={metadata}>

  <!-- HEADER -->
  <div class="text-center px-4 py-12 sm:py-24">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-black">
      Book a Professional Home Stairlift Assessment
    </h1>
    <p class="mt-3 text-gray-600">
      Choose a time that works for your home assessment.
    </p>
  </div>

  <!-- MAIN SECTION -->
  <section
    class="px-4 sm:px-6 lg:px-8 py-10 lg:py-16
           bg-[color-mix(in_srgb,var(--aw-color-secondary)_4%,transparent)]"
  >
    <div class="max-w-[1440px] mx-auto">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12 items-start">

        <!-- LEFT -->
        <div class="space-y-6 w-full lg:pr-12">
          <h2 class="text-3xl sm:text-4xl lg:text-5xl font-black leading-tight">
            Schedule a<br />home visit to<br />discuss your needs.
          </h2>

          <p class="text-gray-600 max-w-lg">
            Our experts will visit your home and guide you through the next steps.
          </p>

          <div class="space-y-4 pt-4">
            <div class="flex gap-3">
              <span class="font-semibold">E-mail:</span>
              <span>{globalData?.conatact_email}</span>
            </div>
            <div class="flex gap-3">
              <span class="font-semibold">Ph. no:</span>
              <span>{globalData?.contact_number}</span>
            </div>
          </div>
        </div>

        <!-- FORM -->
        <div class="w-full">
          <h3 class="text-2xl font-bold mb-6">Schedule Your Assessment</h3>

          <form id="contact-form" class="space-y-5">

            <div>
              <label class="block text-sm font-medium mb-1">Name</label>
              <input
                name="name"
                required
                placeholder="Your Name"
                class="w-full px-4 py-3 border rounded-lg"
              />
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium mb-1">Phone Number</label>
                <input
                  name="phone_number"
                  required
                  placeholder="Your Phone No."
                  class="w-full px-4 py-3 border rounded-lg"
                />
              </div>

              <div>
                <label class="block text-sm font-medium mb-1">
                  Preferred Date
                </label>
                <input
                type="date"
                min={today}
                class="
                  w-full
                  px-4 py-3
                  border
                  rounded-lg
                  border-gray-300
                  focus:border-[#5b3b2e]
                  focus:ring-2
                  focus:ring-[#5b3b2e]
                  focus:ring-offset-0
                "
              />
              
              </div>
              
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium mb-1">Time Slot</label>
                <select
                  name="slots"
                  required
                  class="w-full px-4 py-3 border rounded-lg bg-white"
                >
                  <option value="">Select Time Slot</option>

                  {timeSlots.map((slot:any, index) => {
                    const value = typeof slot === 'object' && slot.id ? slot.id : (typeof slot === 'string' ? slot : `fallback-${index}`);
                    const label = typeof slot === 'object' && slot.label ? slot.label : (typeof slot === 'string' ? slot : 'Unknown Slot');
                    return <option value={value}>{label}</option>;
                  })}
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium mb-1">Property Address</label>
                <input
                  name="address"
                  required
                  placeholder="Property Address"
                  class="w-full px-4 py-3 border rounded-lg"
                />
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium mb-1">Email</label>
              <input
                type="email"
                name="email"
                required
                placeholder="Your Email"
                class="w-full px-4 py-3 border rounded-lg"
              />
            </div>

            <button
              type="submit"
              class="w-full bg-[#5b3b2e] text-white py-3 rounded-lg font-semibold"
            >
              Schedule Your Assessment
            </button>

          </form>
        </div>

      </div>
    </div>
  </section>

  <!-- SUCCESS MODAL -->
  <div
    id="success-modal"
    class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50"
  >
    <div class="bg-white rounded-2xl p-8 text-center max-w-sm w-full animate-scaleIn">
      <div class="mx-auto w-16 h-16 rounded-full bg-green-500 flex items-center justify-center mb-4">
        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
            d="M5 13l4 4L19 7" />
        </svg>
      </div>
      <h3 class="text-2xl font-bold mb-2">Message Sent!</h3>
      <p class="text-gray-600 mb-6">
        Thank you for contacting us. We’ll get back to you shortly.
      </p>
      <button
        id="close-modal"
        class="px-6 py-2 bg-[#C89945] text-white rounded-lg font-semibold"
      >
        Close
      </button>
    </div>
  </div>

</PageLayout>

<script is:inline>
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("contact-form");
    const modal = document.getElementById("success-modal");
    const closeBtn = document.getElementById("close-modal");

    form?.addEventListener("submit", async (e) => {
      e.preventDefault();

      const payload = Object.fromEntries(new FormData(form));

      try {
        const response = await fetch(`http://0.0.0.0:8055/items/schedule_assessment`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status} - ${response.statusText}`);
        }

        modal.classList.remove("hidden");
        modal.classList.add("flex");
        form.reset();
      } catch (error) {
        console.error("Submission error:", error);
        alert(`Something went wrong: ${error.message}. Check the console for details (e.g., network/auth issues).`);
      }
    });

    closeBtn?.addEventListener("click", () => {
      modal.classList.add("hidden");
      modal.classList.remove("flex");
    });
  });
</script>

<style>
@keyframes scaleIn {
  from { transform: scale(.9); opacity: 0 }
  to { transform: scale(1); opacity: 1 }
}
.animate-scaleIn {
  animation: scaleIn .25s ease-out;
}

</style>
